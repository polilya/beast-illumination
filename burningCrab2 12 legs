import machine
import neopixel
import time
import random

# –ü–∏–Ω—ã –¥–ª—è 4 –Ω–æ–≥
LED_PINS = [2, 4, 5, 12, 13, 14, 15, 18, 19, 21, 22, 23]  # 12 GPIO-–ø–∏–Ω–æ–≤ # GPIO –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≥–∏
NUM_PIXELS = 102  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—Ç–æ–¥–∏–æ–¥–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–≥–µ

# –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç—ã NeoPixel –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≥–∏
legs = [neopixel.NeoPixel(machine.Pin(pin), NUM_PIXELS) for pin in LED_PINS]

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–≥–Ω—è
WAVE_SPEED = 0.08  # –°–∫–æ—Ä–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
FLICKER_PROBABILITY = 0.82  # –®–∞–Ω—Å —Å–ª—É—á–∞–π–Ω–æ–π –≤—Å–ø—ã—à–∫–∏
MAX_WAVES = 19  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–ª–Ω –Ω–∞ –∫–∞–∂–¥—É—é –Ω–æ–≥—É

# –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ–≥–Ω—è (–ø–æ –º–µ—Ä–µ —É–≥–∞—Å–∞–Ω–∏—è)
FIRE_COLORS = [
    (0, 0, 0),       # ‚ö´ –ù–µ—Ç –æ–≥–Ω—è
    (50, 0, 0),      # üî¥ –¢—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π (—Å–ª–∞–±–æ–µ —Ç–ª–µ–Ω–∏–µ)
    (150, 30, 0),    # üî¥üî• –ö—Ä–∞—Å–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π (—Ä–∞–∑–≥–æ—Ä–∞–µ—Ç—Å—è)
    (255, 80, 0),    # üü† –Ø—Ä–∫–∏–π –æ—Ä–∞–Ω–∂–µ–≤—ã–π (–ø–∏–∫ –æ–≥–Ω—è)
    (255, 150, 0),   # üü° –û—Å–ª–∞–±–µ–≤–∞—é—â–∏–π –æ–≥–æ–Ω—å
]

# –î–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≥–∏ —Å–æ–∑–¥–∞—ë–º —Å–≤–æ–π —Å–ø–∏—Å–æ–∫ –≤–æ–ª–Ω
fire_waves = [[] for _ in range(len(legs))]

def clear_pixels():
    """–ì–∞—Å–∏—Ç –≤—Å–µ –ø–∏–∫—Å–µ–ª–∏ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º"""
    for leg in legs:
        for i in range(NUM_PIXELS):
            leg[i] = (0, 0, 0)
        leg.write()

clear_pixels()

def start_new_wave(leg_index):
    """–°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –≤–æ–ª–Ω—É –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–π –Ω–æ–≥–µ"""
    if len(fire_waves[leg_index]) < MAX_WAVES and random.random() < FLICKER_PROBABILITY:
        start_pos = random.randint(0, NUM_PIXELS - 1)  # –°–ª—É—á–∞–π–Ω—ã–π –ø–∏–∫—Å–µ–ª—å
        fire_waves[leg_index].append({
            "center": start_pos,
            "radius": 0,
            "max_radius": random.randint(6, 18),  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤–æ–ª–Ω—ã
            "intensity": len(FIRE_COLORS) - 1
        })

def update_waves():
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –≤–æ–ª–Ω—ã, —Ä–∞—Å—à–∏—Ä—è—è –∏—Ö –∏ —É–º–µ–Ω—å—à–∞—è —è—Ä–∫–æ—Å—Ç—å"""
    for leg_index in range(len(legs)):
        for wave in fire_waves[leg_index]:
            wave["radius"] += 1
            wave["intensity"] = max(1, wave["intensity"] - 1)

        # –£–¥–∞–ª—è–µ–º –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –≤–æ–ª–Ω—ã
        fire_waves[leg_index] = [wave for wave in fire_waves[leg_index] if wave["radius"] <= wave["max_radius"]]

def apply_fire():
    """–ü—Ä–∏–º–µ–Ω—è–µ—Ç –æ–≥–æ–Ω—å –∫–æ –≤—Å–µ–º –Ω–æ–≥–∞–º"""
    for leg_index, leg in enumerate(legs):
        fire_map = [0] * NUM_PIXELS  # –û—á–∏—Å—Ç–∫–∞ –∫–∞—Ä—Ç—ã –æ–≥–Ω—è

        for wave in fire_waves[leg_index]:
            center = wave["center"]
            radius = wave["radius"]
            intensity = wave["intensity"]

            for i in range(NUM_PIXELS):
                distance = abs(i - center)
                if distance <= radius:
                    fire_map[i] = max(fire_map[i], intensity - (distance // 2))

        # –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–∞ —Å–≤–µ—Ç–æ–¥–∏–æ–¥–æ–≤
        for i in range(NUM_PIXELS):
            level = min(fire_map[i], len(FIRE_COLORS) - 1)
            leg[i] = FIRE_COLORS[level]

        leg.write()

def fire_effect():
    """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —ç—Ñ—Ñ–µ–∫—Ç–∞"""
    while True:
        for leg_index in range(len(legs)):
            start_new_wave(leg_index)  # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ª–Ω—ã
        update_waves()  # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –≤–æ–ª–Ω—ã
        apply_fire()  # –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –∫–æ –≤—Å–µ–º –Ω–æ–≥–∞–º
        time.sleep(WAVE_SPEED)

# –ó–∞–ø—É—Å–∫ —ç—Ñ—Ñ–µ–∫—Ç–∞
fire_effect()
